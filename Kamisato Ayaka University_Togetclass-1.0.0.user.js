// ==UserScript==
// @name         Kamisato Ayaka University_Togetclass
// @license      Mozilla Public License 2.0 (MPL)
// @namespace    http://tampermonkey.net/
// @version      1.0.0
// @description
// @author       Yencry
// @grant        none
// @match        https://jxw.sylu.edu.cn/xsxk/*
// ==/UserScript==
(function(){'use strict';const registrationInterval=500;const scavengingInterval=30000;const closePopupInterval=300;const activationOffset=2000;let registrationTimer=null;let countdownTimer=null;let activationTimeout=null;function createToggleSwitch(){const container=document.createElement('div');container.id="gm-container";container.innerHTML=`<div id="gm-header"><div id="gm-time-display">--:--:--</div></div><div id="gm-body"><div class="gm-divider"></div><div id="gm-course-selector"><select id="gm-course-dropdown"><option value="">--- 请先点击刷新 ---</option></select><button id="gm-refresh-courses" title="刷新课程列表"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path><path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path></svg></button></div><div class="gm-divider"></div><div class="gm-switch-row"><span class="gm-toggle-label">自动抢课</span><label class="gm-switch"><input type="checkbox" id="gm-course-toggle"><span class="gm-slider"></span></label></div><div class="gm-switch-row"><span class="gm-toggle-label">捡漏模式</span><label class="gm-switch"><input type="checkbox" id="gm-scavenge-toggle"><span class="gm-slider"></span></label></div><div class="gm-divider"></div><div id="gm-timer-section"><input type="time" id="gm-timer-input" step="1"><button id="gm-timer-button">设定时</button></div><div id="gm-timer-status">未设定时</div><div class="gm-divider"></div><div id="gm-log-header"><span class="gm-log-title">运行日志</span><button id="gm-clear-log">清空</button></div><div id="gm-log-container"></div><div id="gm-welcome-message"></div></div>`;document.body.appendChild(container);const styles=`#gm-container{position:fixed;background-color:rgba(255,255,255,0.7);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);border-radius:15px;z-index:9999;display:flex;flex-direction:column;box-shadow:0 8px 32px 0 rgba(31,38,135,0.37);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;width:280px}#gm-header{padding:5px;cursor:move;background-color:rgba(0,0,0,0.05);border-top-left-radius:15px;border-top-right-radius:15px}#gm-body{padding:0 15px 15px 15px}#gm-time-display{font-size:18px;font-weight:600;color:#333;text-align:center}.gm-divider{height:1px;background-color:rgba(255,255,255,0.3);margin:10px 0}#gm-course-selector{display:flex;align-items:center}#gm-course-dropdown{flex-grow:1;border:1px solid #ccc;border-radius:5px;padding:5px;font-size:12px}#gm-course-dropdown:disabled{background-color:#f8f9fa;cursor:not-allowed}#gm-refresh-courses{background-color:#6c757d;color:white;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;margin-left:10px;display:flex;align-items:center;justify-content:center;transition:transform .2s,background-color .2s}#gm-refresh-courses:hover{background-color:#5a6268;transform:scale(1.1)}#gm-refresh-courses:disabled{background-color:#adb5bd;cursor:not-allowed;transform:none}.gm-switch-row{display:flex;align-items:center;justify-content:space-between;width:100%;margin-top:10px}.gm-toggle-label{margin-right:15px;font-size:14px;color:#333;font-weight:500}.gm-switch{position:relative;display:inline-block;width:50px;height:24px}.gm-switch input:disabled+.gm-slider{background-color:#e9ecef;cursor:not-allowed}.gm-switch input{opacity:0;width:0;height:0}.gm-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:24px}.gm-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%}input:checked+.gm-slider{background-color:#0d6efd}input:checked+.gm-slider:before{transform:translateX(26px)}#gm-timer-section{display:flex;align-items:center;justify-content:space-between}#gm-timer-input{border:1px solid #ccc;border-radius:5px;padding:4px;font-size:14px;width:100px}#gm-timer-button{background-color:#0d6efd;color:white;border:none;border-radius:5px;padding:5px 10px;cursor:pointer;font-size:14px;margin-left:10px;transition:transform .2s,background-color .2s}#gm-timer-button:hover{background-color:#0b5ed7;transform:scale(1.05)}#gm-timer-button.cancel{background-color:#dc3545}#gm-timer-button.cancel:hover{background-color:#bb2d3b}#gm-timer-status{font-size:12px;color:#444;text-align:center;margin-top:8px;min-height:16px;font-weight:500}#gm-log-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}.gm-log-title{font-size:14px;font-weight:500;color:#333}#gm-clear-log{font-size:10px;background-color:rgba(255,255,255,0.5);border:1px solid #ddd;border-radius:4px;padding:2px 6px;cursor:pointer}#gm-clear-log:hover{background-color:rgba(255,255,255,0.8)}#gm-log-container{height:80px;overflow-y:auto;border:1px solid rgba(255,255,255,0.3);border-radius:5px;padding:8px;background-color:rgba(250,250,250,0.5);font-size:12px}.gm-log-entry{margin-bottom:4px;color:#495057}.gm-log-entry.success{color:#198754;font-weight:500}.gm-log-entry.error{color:#dc3545;font-weight:500}#gm-welcome-message{font-size:10px;color:#6c757d;text-align:center;margin-top:5px;user-select:none}`;const styleSheet=document.createElement("style");styleSheet.innerText=styles;document.head.appendChild(styleSheet);container.style.top=(window.innerHeight-container.offsetHeight-20)+'px';container.style.left=(window.innerWidth-container.offsetWidth-20)+'px';document.getElementById('gm-course-toggle').addEventListener('change',(e)=>handleToggleChange(e.currentTarget,'gm-scavenge-toggle',registrationInterval,"自动抢课"));document.getElementById('gm-scavenge-toggle').addEventListener('change',(e)=>handleToggleChange(e.currentTarget,'gm-course-toggle',scavengingInterval,"捡漏模式"));document.getElementById('gm-timer-button').addEventListener('click',handleTimerButtonClick);document.getElementById('gm-refresh-courses').addEventListener('click',scanAndPopulateCourses);document.getElementById('gm-clear-log').addEventListener('click',()=>{document.getElementById('gm-log-container').innerHTML='';});makeDraggable(container);updateCurrentTime();setInterval(updateCurrentTime,1000);setWelcomeMessage();logMessage("脚本已加载，请刷新课程列表。");}
function logMessage(message,type='info'){const logContainer=document.getElementById('gm-log-container');if(!logContainer)return;const entry=document.createElement('div');entry.className=`gm-log-entry ${type}`;entry.textContent=`[${new Date().toLocaleTimeString('zh-CN')}] ${message}`;logContainer.appendChild(entry);logContainer.scrollTop=logContainer.scrollHeight;}
function scanAndPopulateCourses(){const dropdown=document.getElementById('gm-course-dropdown');dropdown.innerHTML='<option value="">--- 请选择一门课程 ---</option>';let count=0;document.querySelectorAll('button').forEach(button=>{if(button.textContent.trim()==='选课'){const onclickAttr=button.getAttribute('onclick');if(onclickAttr&&onclickAttr.includes('chooseCourseZzxk')){const courseName=button.closest('tr')?.querySelector('.jxbmc')?.textContent.trim();if(courseName){const option=document.createElement('option');option.value=onclickAttr;option.textContent=courseName;dropdown.appendChild(option);count++;}}}});logMessage(`扫描完成，找到 ${count} 门可选课程。`);if(count===0)dropdown.querySelector('option').textContent="--- 未找到可选课程 ---";}
function handleToggleChange(self,otherToggleId,interval,modeName){const otherToggle=document.getElementById(otherToggleId);if(self.checked){const selectedOnclick=document.getElementById('gm-course-dropdown').value;if(!selectedOnclick){logMessage("请先从下拉列表中选择课程！",'error');self.checked=false;return;}
otherToggle.checked=false;startRegistration(interval,modeName,selectedOnclick);}else{stopRegistration();}}
function handleTimerButtonClick(){const timerButton=document.getElementById('gm-timer-button');const statusDisplay=document.getElementById('gm-timer-status');const selectedOnclick=document.getElementById('gm-course-dropdown').value;if(timerButton.classList.contains('cancel')){clearTimeout(activationTimeout);clearInterval(countdownTimer);activationTimeout=null;countdownTimer=null;timerButton.textContent='设定时';timerButton.classList.remove('cancel');statusDisplay.textContent='未设定时';logMessage('定时任务已取消。');setControlsDisabled(false);}else{if(!selectedOnclick){logMessage("请先选择课程再设定时！",'error');return;}
const targetTimeStr=document.getElementById('gm-timer-input').value;if(!targetTimeStr){logMessage('请先设定时间。','error');return;}
const targetTime=new Date();targetTime.setHours(...targetTimeStr.split(':'),0,0);const delay=targetTime.getTime()-new Date().getTime();if(delay<=0){logMessage('设定时间已过，请重设。','error');return;}
const activationDelay=delay-activationOffset;if(activationDelay<0){logMessage('时间太近，无法设定。','error');return;}
setControlsDisabled(true);timerButton.textContent='取消';timerButton.classList.add('cancel');logMessage(`定时任务已设定，将于 ${targetTime.toLocaleTimeString('zh-CN')} 自动抢课。`);activationTimeout=setTimeout(()=>{document.getElementById('gm-course-toggle').checked=true;startRegistration(registrationInterval,"自动抢课",selectedOnclick);clearInterval(countdownTimer);statusDisplay.textContent='未设定时';logMessage('时间到，抢课已自动开启！','success');timerButton.textContent='设定时';timerButton.classList.remove('cancel');setControlsDisabled(false);},activationDelay);countdownTimer=setInterval(()=>{const remaining=targetTime.getTime()-new Date().getTime();if(remaining<=0)clearInterval(countdownTimer);else{const h=Math.floor(remaining/3600000).toString().padStart(2,'0');const m=Math.floor((remaining%3600000)/60000).toString().padStart(2,'0');const s=Math.floor((remaining%60000)/1000).toString().padStart(2,'0');statusDisplay.textContent=`倒计时: ${h}:${m}:${s}`;}},1000);}}
function startRegistration(interval,modeName,onclickCommand){stopRegistration();logMessage(`【${modeName}】已开启。`,'success');registrationTimer=setInterval(()=>{try{new Function(onclickCommand)();logMessage(`正在以【${modeName}】尝试选课...`);}catch(e){logMessage("执行选课命令时出错。",'error');stopRegistration();}},interval);}
function stopRegistration(){if(registrationTimer){clearInterval(registrationTimer);registrationTimer=null;logMessage("所有自动选课模式已关闭。");}}
function updateCurrentTime(){const timeDisplay=document.getElementById('gm-time-display');if(timeDisplay)timeDisplay.textContent=new Date().toLocaleTimeString('zh-CN');}
function setControlsDisabled(disabled){['gm-course-toggle','gm-scavenge-toggle','gm-course-dropdown','gm-refresh-courses'].forEach(id=>{const el=document.getElementById(id);if(el)el.disabled=disabled;});}
function setWelcomeMessage(){const studentName=document.getElementById('xm')?.value||'';const currentHour=new Date().getHours();const timeGreeting=currentHour>=5&&currentHour<12?'早上好':(currentHour>=12&&currentHour<18?'中午好':'晚上好');const welcomeElement=document.getElementById('gm-welcome-message');if(welcomeElement){welcomeElement.textContent=`${studentName}，${timeGreeting}，欢迎来到神里凌华大学白鹭教务`;}}
function makeDraggable(elmnt){let pos1=0,pos2=0,pos3=0,pos4=0;const header=document.getElementById("gm-header");if(header){header.onmousedown=dragMouseDown;}
function dragMouseDown(e){e=e||window.event;e.preventDefault();if(elmnt.style.bottom!=='auto'||elmnt.style.right!=='auto'){const rect=elmnt.getBoundingClientRect();elmnt.style.top=rect.top+'px';elmnt.style.left=rect.left+'px';elmnt.style.bottom='auto';elmnt.style.right='auto';}
pos3=e.clientX;pos4=e.clientY;document.onmouseup=closeDragElement;document.onmousemove=elementDrag;}
function elementDrag(e){e=e||window.event;e.preventDefault();pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;elmnt.style.top=(elmnt.offsetTop-pos2)+"px";elmnt.style.left=(elmnt.offsetLeft-pos1)+"px";}
function closeDragElement(){document.onmouseup=null;document.onmousemove=null;}}
setInterval(()=>{try{const confirmButton=document.getElementById('btn_ok');if(confirmButton&&confirmButton.offsetParent!==null){confirmButton.click();logMessage("已自动关闭“无余量”弹窗。","success");}}catch(e){}},closePopupInterval);createToggleSwitch();})();
